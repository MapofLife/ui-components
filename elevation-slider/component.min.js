/*! 2015-07-24 */
angular.module("mol-point-filters-templates",["mol-point-filters-control.html"]),angular.module("mol-point-filters-control.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("mol-point-filters-control.html",'<div class=well ng-show="initialized && histogram.histogram_values"><div><b>Point filters</b><div class=histogram_totals>{{totals.combined | number}} of {{totals.total | number}} selected</div><div class=histogram_filter><checkbox class=btn-primary ng-model=filters.uncertainty></checkbox><b class=clickable tooltip="\n      Spatial uncertainty of an observation, in kilometers. 20km if no uncertainty is provided with the observation.">Uncertainty</b><div class=histogram_totals>{{totals.uncertainty | number}} selected</div><div class=histogram_container><table class=histogram width=100%><tr><td colspan=1></td><td valign=bottom colspan=2 ng-repeat="bucket in histogram.uncertainty_buckets | toArray"><div class=bar tooltip-placement=right tooltip="{{bucket.ct | number}} point records available with a geographic uncertainty between {{bucket.min | mKm}} and {{bucket.max | mKm}}." ng-style={height:bucket.height}></div></td><td colspan=1></td></tr><tr><td colspan=1></td><td colspan=2 halign=middle valign=bottom ng-repeat="bucket in histogram.uncertainty_buckets | toArray"><div class=tick></div></td><td colspan=1><div class=tick></div></td></tr><tr><td valign=bottom halign=middle colspan=2 ng-repeat="bucket in histogram.uncertainty_buckets | toArray"><div ng-class-even="\'tick_label_odd\'" class=tick_label>{{bucket.min/1000}}</div></td><td colspan=2><div class=tick_label>&infin;</div></td></tr><tr><td colspan="{{((histogram.uncertainty_buckets | toArray).length+1)*2+1}}"><div class=sliders range-slider show-values=false step=1 min=1 max=steps.uncertainty_bucket prevent-equal-min-max ng-mouseup=updateModel() model-min=selected.uncertainty.min model-max=selected.uncertainty.max></div></td></tr></table></div></div><div class=histogram_filter><checkbox class=btn-primary ng-model=filters.years></checkbox><b>Years</b><div class=histogram_totals>{{totals.years | number}} selected</div><div class=histogram_container><table class=histogram width=100%><tr><td valign=bottom colspan=2><div class=bar tooltip-placement=right tooltip="{{histogram.year_buckets[\'0\'].ct}} point records available with no year value." ng-style="{height:histogram.year_buckets[\'0\'].height}"></div></td><td colspan=3 halign=middle valign=bottom></td><td colspan=2 halign=middle valign=bottom ng-repeat="bucket in (histogram.year_buckets | toArray).splice(1)"><div class=bar tooltip-placement=right tooltip="{{bucket.ct | number}} point records available between {{(bucket.min > 0) ? bucket.min : \'the beginning of time\'}} and {{(bucket.max < 2015)?bucket.max:\' the present\'}}." ng-style={height:bucket.height}></div></td><td colspan=1></td></tr><tr><td colspan=1></td><td colspan=2 halign=middle valign=bottom><div class=tick></div></td><td colspan=2 halign=middle valign=bottom></td><td colspan=2 halign=middle valign=bottom ng-repeat="bucket in (histogram.year_buckets | toArray).slice(1)"><div class=tick></div></td><td colspan=1><div class=tick></div></td></tr><tr><td colspan=2 halign=middle valign=bottom><div class=tick_label>N/A</div></td><td colspan=2 halign=middle valign=bottom></td><td colspan=2 halign=middle ng-repeat="bucket in (histogram.year_buckets | toArray).slice(1)"><div ng-class-even="\'tick_label_odd\'" class=tick_label>{{(bucket.min>0)? bucket.min : \'BC\'}}</div></td><td colspan=2 halign=middle><div class=tick_label>Now</div></td></tr><tr><td tooltip="Check to include points with no year recorded." tooltip-placement=right halign=middle style=text-align:center colspan=2><checkbox class=btn-primary ng-model=year.nulls></checkbox></td><td colspan=2></td><td colspan="{{((histogram.year_buckets | toArray).length)*2+1}}"><div class=sliders range-slider show-values=false step=1 min=1 max=steps.year_bucket-1 prevent-equal-min-max ng-mouseup=updateModel() model-min=selected.year.min model-max=selected.year.max></div></td></tr></table></div><div ng-show="totals.total>5000" class=histogram_filter><checkbox class=btn-primary ng-model=filters.limit></checkbox>Limit map to most recent {{limit}} points.<div style=width:90%;margin:5px range-slider show-values=false step=500 min=0 max=50000 pin-handle=min prevent-equal-min-max ng-mouseup=updateModel() model-max=selected.limit></div></div></div></div></div>')}]),angular.module("mol.point-filters",["mol-point-filters-templates"]).directive("pointsHistogram",["MOLServices",function(MOLServices){return{restrict:"E",scope:{scientificname:"=scientificname",uncertainty:"=uncertainty",year:"=years",types:"=types",filters:"=filters",limit:"=limit"},templateUrl:"mol-point-filters-control.html",controller:function($scope){$scope.initialized=!1,$scope._year={min:1970,max:2015,nulls:!1},$scope._uncertainty={min:0,max:32e3},$scope.steps={uncertainty_bucket:10,year_bucket:11},$scope.selected={uncertainty:{min:1,max:9},year:{min:4,max:11,nulls:!1},limit:5e3},$scope.getBucketCt=function(type,bucket){var ct=0;return $scope.histogram?(angular.forEach($scope.histogram.histogram_values,function(values,i){ct+=values[type]==bucket&&$scope.checkDataset(values)?values.ct:0}),ct):null},$scope.updateBucketCounts=function(){$scope.histogram&&($scope.steps={uncertainty_bucket:1,year_bucket:1},angular.forEach($scope.histogram.limits,function(val,type){angular.forEach($scope.histogram["{0}s".format(type)],function(bucket_values,bucket){var bucket_ct=$scope.getBucketCt(type,bucket);$scope.histogram.limits[type]=bucket_ct>$scope.histogram.limits[type]?bucket_ct:$scope.histogram.limits[type],$scope.steps[type]++})}),angular.forEach($scope.histogram.uncertainty_buckets,function(bucket,id){bucket.ct=$scope.getBucketCt("uncertainty_bucket",id),bucket.height=$scope.getBucketHeight("uncertainty_bucket",bucket)}),angular.forEach($scope.histogram.year_buckets,function(bucket,id){bucket.ct=$scope.getBucketCt("year_bucket",id),bucket.height=$scope.getBucketHeight("year_bucket",bucket)}))},$scope.checkDataset=function(values){return $scope.types&&$scope.types[values.type]&&$scope.types[values.type].visible&&$scope.types[values.type].datasets[values.dataset_id]&&$scope.types[values.type].datasets[values.dataset_id].visible?!0:!1},$scope.getBucketHeight=function(type,bucket){function logScale(n,base){return Math.log(n*(base-1)+1)/Math.log(base)}var height=1;return $scope.histogram.limits[type]>=1&&(height=20*logScale(bucket.ct/$scope.histogram.limits[type],15)),"{0}px".format(Math.max(height,.01))},$scope.updateTotals=function(){$scope.histogram&&($scope.totals={total:0,combined:0,uncertainty:0,years:0},angular.forEach($scope.histogram.histogram_values,function(values,i){$scope.checkDataset(values)&&values.uncertainty_bucket>=$scope.selected.uncertainty.min&&values.uncertainty_bucket<$scope.selected.uncertainty.max&&($scope.totals.uncertainty+=values.ct),$scope.checkDataset(values)&&(values.year_bucket>=$scope.selected.year.min&&values.year_bucket<$scope.selected.year.max||$scope.year.nulls&&!values.year_bucket)&&($scope.totals.years+=values.ct),$scope.checkDataset(values)&&(values.uncertainty_bucket>=$scope.selected.uncertainty.min&&values.uncertainty_bucket<$scope.selected.uncertainty.max||!$scope.filters.uncertainty)&&(!$scope.filters.years||values.year_bucket>=$scope.selected.year.min&&values.year_bucket<$scope.selected.year.max||$scope.year.nulls&&!values.year_bucket)&&($scope.totals.combined+=values.ct),$scope.totals.total+=values.ct}),$scope.updateModel())},$scope.updateModel=function(){$scope.year.min=$scope._year.min,$scope.year.max=$scope._year.max,$scope.uncertainty.min=$scope._uncertainty.min,$scope.uncertainty.max=$scope._uncertainty.max,$scope.limit=$scope.selected.limit},$scope.$watch("year",function(newValue,oldValue){newValue&&$scope.updateTotals()},!0),$scope.$watch("filters",function(newValue,oldValue){newValue&&$scope.updateTotals()},!0),$scope.$watch("selected",function(newValue,oldValue){newValue&&$scope.histogram&&$scope.initialized&&($scope._year.min=$scope.histogram.year_buckets[newValue.year.min].min,$scope._year.max=$scope.histogram.year_buckets[newValue.year.max-1].max,$scope._year.nulls=newValue.year.nulls,$scope._uncertainty.min=$scope.histogram.uncertainty_buckets[newValue.uncertainty.min].min,$scope._uncertainty.max=$scope.histogram.uncertainty_buckets[newValue.uncertainty.max-1].max,$scope.updateTotals())},!0),$scope.$watch("types.points",function(newValue,oldValue){newValue&&$scope.histogram&&$scope.initialized&&($scope.updateBucketCounts(),$scope.updateTotals())},!0),$scope.$watch("scientificname",function(newValue,oldValue){newValue&&($scope.initialized=!1,MOLServices("pointshistogram",{scientificname:newValue},!0).success(function(result){$scope.histogram=result,$scope.histogram.limits={uncertainty_bucket:1,year_bucket:1},$scope.steps={uncertainty_bucket:1,year_bucket:1},$scope.updateBucketCounts(),$scope.updateTotals(),$scope.updateModel(),$scope.initialized=!0}))})}}}]);