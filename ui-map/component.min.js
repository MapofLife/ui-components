/*! 2017-06-07 */
angular.module("mol.ui-map",["uiGmapgoogle-maps"]).factory("molUiMap",["uiGmapGoogleMapApi","$http","$q","$rootScope","$timeout",function(a,b,c,d,e){function f(c){function f(a,b,c){var d=null,e=a.x;a.y;if(c&&a.y<Math.pow(2,b)&&a.y>=0){for(d=c;e<0;)e+=Math.pow(2,b);for(;e>=Math.pow(2,b);)e-=Math.pow(2,b);d=c.replace("{z}",b).replace("{x}",e).replace("{y}",a.y)}return d}function g(a,c,g){var i,j=document.createElement("img"),k=document.createElement("div"),l=document.createElement("canvas"),m=(l.getContext("2d"),f(a,c,this.overlay.tile_url)),n=h.utfGrid;try{"null"!=="{0}".format(this.overlay.grid_url)&&(i=f(a,c,this.overlay.grid_url))&&(n||(n={}),n[c]||(n[c]={}),n[c][a.x]||(n[c][a.x]={}),n[c][a.x][a.y]||(1==angular.version.major&&angular.version.minor<6?b({url:"{0}?callback=JSON_CALLBACK".format(i),method:"JSONP",ignoreLoadingbar:!0}).success(function(b,d,e,f){n[c][a.x][a.y]=b}).error(function(a){}):b.jsonp(i,{jsonpCallbackParam:"callback"}).success(function(b){n[c][a.x][a.y]=b})))}catch(a){}return j.style.opacity=this.opacity,l.width=j.width=k.style.width=this.tileSize.width,l.height=j.height=k.style.width=this.tileSize.height,m?(j.onload=function(a){delete h.tiles[m],Object.keys(h.tiles).length<1&&d.$emit("cfpLoadingBar:completed")},j.onerror=function(a){h.tiles[m]<h.maxTries?(h.tiles[m]++,e(function(){this.src=m},500)):(delete h.tiles[m],j.src="static/app/img/blank_tile.png",Object.keys(this.tiles).length<1&&d.$emit("cfpLoadingBar:completed"))},d.$emit("cfpLoadingBar:started"),this.tiles[m]=0,j.src=m,l.onclick=this.click,j):k}var h=this;c=angular.copy(c),this.show=!0,this.tiles={},this.getTile=g,a.then(function(a){h.tileSize=new google.maps.Size(256,256)}),this.name=c.type,this.overlay=c,this.index=c.index,this.refresh=!0,this.opacity=c.opacity,this.maxZoom=10,this.utfGrid={}}function g(){var a=this;this.tiles={},this.map={},this.bounds={},this.center={latitude:0,longitude:0},this.zoom=0,this.control={},this.options={streetViewControl:!1,panControl:!1,maxZoom:10,minZoom:3,styles:styles,mapTypeControlOptions:{position:5}},this.utfGrid={},this.infowindow={},this.overlayMapTypes=[new f({tile_url:"",index:0}),new f({tile_url:"",index:1})],this.events={click:angular.bind(a,a.interactivity),mousemove:angular.bind(a,a.interactivity)},this.clearOverlays=function(){a.utfGrid={},a.overlayMapTypes=[new f({tile_url:"",index:0}),new f({tile_url:"",index:1})]},this.removeOverlay=function(a){this.overlayMapTypes[a]=new f({tile_url:""})},this.setOverlay=function(a,b){this.overlayMapTypes[b]=new f(a)}}return g.prototype.interactivity=function(a,b,c){var d=this,e=this.getGridData(a,c);e?a.setOptions({draggableCursor:"pointer"}):a.setOptions({draggableCursor:"default"});try{this.getInfoWindowModel(a,b,c[0].latLng,e).then(function(a){a&&(d.infowindow=angular.extend({coords:{latitude:c[0].latLng.lat(),longitude:c[0].latLng.lng()}},a))})}catch(a){}},g.prototype.resize=function(){var b=this;a.then(function(a){try{for(var c=b.control.getGMap(),d=c.getCenter(),f=0;f<=700;f+=4)e(function(){google.maps.event.trigger(c,"resize"),c.panTo(d)},f)}catch(a){}})},g.prototype.getInfoWindowModel=function(a,b,d,e){return c.defer().promise},g.prototype.getGridData=function(a,b){var c,d,e,f=this.overlayMapTypes[0].utfGrid,g=a.getZoom(),h=1<<g,i=new MercatorProjection,j=i.fromLatLngToPoint(b[0].latLng),k=new google.maps.Point(j.x*h,j.y*h),l=new google.maps.Point(Math.floor(k.x/256),Math.floor(k.y/256)),m=new google.maps.Point(Math.floor((k.x-256*l.x)/4),Math.floor((k.y-256*l.y)/4));try{c=f[g][l.x][l.y].grid[m.y].charCodeAt(m.x),c>=93&&c--,c>=35&&c--,c-=32,d=f[g][l.x][l.y].keys[c],e=f[g][l.x][l.y].data[String(d)]}catch(a){}return e},g}]);